# 다양한 종류의 연관관계 매핑

## Index

- [다양한 종류의 연관관계 매핑](#다양한-종류의-연관관계-매핑)
  - [Index](#index)
  - [연관관계를 매핑시 고려사항](#연관관계를-매핑시-고려사항)
  - [다대일 (N:1)](#다대일-n1)
  - [일대다 (1:N)](#일대다-1n)
    - [일대다 연관관계의 특징](#일대다-연관관계의-특징)
    - [일대다 연관관계의 단점](#일대다-연관관계의-단점)
    - [일대다의 양방향 매핑법](#일대다의-양방향-매핑법)
  - [일대일 (1:1)](#일대일-11)
    - [일대일 관계의 특징](#일대일-관계의-특징)
  - [다대다 (N:M)](#다대다-nm)
    - [활용법](#활용법)
    - [다대다의 단점](#다대다의-단점)
    - [다대다의 단점을 보완하는 방법](#다대다의-단점을-보완하는-방법)
    - [다대다의 권장 설계](#다대다의-권장-설계)

---

## 연관관계를 매핑시 고려사항

- 다중성
  - 다대일 : `@ManyToOne`
  - 일대다 : `@OneToMany`
  - 일대일 : `@OneToOne`
  - 다대다 : `@ManyToMany`
- 단방향, 양방향
  - 테이블은 외래키 하나로 양쪽 조인이 가능하기에 방향이라는 개념이 없다.
  - 객체의 경우 참조용 필드가 있는 쪽으로만 참조가 가능하다.
    - 한쪽만 참조하면 단방향
    - 양쪽만 참조하면 양방향
- 연관관계의 주인

---

## 다대일 (N:1)

- 가장 많이 사용하는 연관관계
- **일대다**를 선언시 반대에서 사용하는 개념

---

## 일대다 (1:N)

### 일대다 연관관계의 특징

- 연관관계의 주인은 1이 된다.
- Team : Member로 생각해보면 Team(1)에서 Member(N)를 관리하는것
  - 즉 DB기준으로 정리를 하면 Member(N) 쪽에 외래키가 있슴.
- `@JoinColumn`을 꼭 사용해야 함. 아니면 조인테이블 방식을 사용해야 함
  - 조인테이블방식이란 중간에 테이블을 하나 추가해서 사용하는 방식

### 일대다 연관관계의 단점

- `@JoinColumn`을 사용하지 않고 설계를 할 경우 엔티티가 관리하는 외래키가 다른 중계테이블에서 관리가 됨
- 연관관계 관리를 위해 Insert, Update이후 추가적으로 관계를 맺기 위한 Update 쿼리가 실행된다.

> 해당 문제는 다대일에서는 없는 문제이기 때문에 일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하는걸 지향하는게 좋다.

### 일대다의 양방향 매핑법

- 일대다의 경우 주인이 1인 경우 Many에서의 매핑법은 방법이 바뀜.
- 공식적인 매핑방법이 아니며 TEAM-MEMBER관계일 경우를 예시로 아래의 코드처럼 작성
  - 다음 방법은 읽기 전용 필드를 사용해서 양방향처럼 사용을 하는 방법이고 Member도 연관관계의 주인이 되는 방법이 아님.
  - 왠만하면 다대일 양방향을 쓰는걸로...

```
@Entity
public class Member {
  ...

  @ManyToOne
  @JoinColumn(name = "TEAM_ID", insertable = false, updatable = false)
  private Team team;
  ...
}
```

---

## 일대일 (1:1)

### 일대일 관계의 특징

- **일대일**의 관계는 그 **반대도 일대일**이다.
- 주 테이블이나 대상테이블 중에 외래 키를 선택가능하다.
  - 주 테이블에 외래 키
  - 대상 테이블에 외래 키
- 외래 키에 DB 유니크키 제약조건이 추가되어야 한다.

> 단방향 양방향의 선언의 경우 다대일, 일대다 매핑처럼 선언하면된다.  
> 연관관계의 주인은 마찬가지로 외래키가 있는곳이 주인이 된다.

---

## 다대다 (N:M)

> 실제 쓰지 않는걸 권장함

- RDB로는 정규화된 테이블 2개로 다대다 관계의 표현이 불가하다.
  - 하지만 객체는 가능하다
- 연결테이블을 추가해서 일대다, 다대일 관계로 풀어내야 한다.(중계 테이블이 필요하다)

### 활용법

- `@ManyToMany`를 활용한다
- `@JoinTable`로 연결테이블을 지정한다.
- 다대다 역시 단방향, 양방향이 가능하다.

### 다대다의 단점

> `@JoinTable`을 통해서 중계 테이블에 대한 지정은 가능하지만 FK를 제외하고 따로 무언가 컬럼의 추가가 불가능하기에 작업에 불편함이 큼

### 다대다의 단점을 보완하는 방법

> `@ManyMToMany`를 활용하는 것보다는 `@OneToMany`, `@ManyToOne`으로 테이블을 풀어내고 중계테이블을 하나의 엔티티를 추가생성해서 중계테이블을 매핑하는 방식으로 사용하는 것을 권장함.

### 다대다의 권장 설계

- 중계테이블에 대해서 무조건 PK를 쓰는 방향
  - 추후 설계가 변경될 때 유연하게 대처가 가능하다
  - PK, FK로 같이 묶는게 아닌 PK따로, FK따로
